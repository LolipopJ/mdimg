"use strict";var e=require("path"),t=require("fs"),r=require("puppeteer"),n=require("marked"),i=require("cheerio");const s=async e=>{const t=new n.marked.Renderer;return t.code=({text:e,lang:t})=>"mermaid"==t?`<pre class="mermaid">${e}</pre>`:`<pre><code class="language-${t}">${e}</code></pre>`,n.marked.parse(e,{renderer:t})},a=async({inputText:n,inputFilename:a,mdText:l,mdFile:c,outputFilename:d,type:m="png",width:p=800,height:h=600,encoding:g="binary",quality:u=100,htmlText:w,cssText:f,htmlTemplate:y="default",cssTemplate:$="default",theme:v="light",log:b=!1,puppeteerProps:x={}})=>{const S=["jpeg","png","webp"],T=["base64","binary","blob"],_={html:"",data:"base64"===g?"":Uint8Array.from([]),path:void 0};let j="";const E=a||c,F=n||l;if(E){const r=e.resolve(E);if(!t.existsSync(r))throw new Error(`Error: input file ${r} is not exists.\n`);if(!t.statSync(r).isFile())throw new Error("Error: input is not a file.\n");j=t.readFileSync(r).toString(),b&&process.stderr.write(`Info: start to convert file ${r} to an image...\n`)}else{if(!F)throw new Error("Error: text or file is required to be converted.\n");j=F,b&&process.stderr.write("Info: start to convert text to an image...\n")}const k=g,M="binary"===k;if(!T.includes(k))throw new Error(`Error: encoding type ${k} is not supported. Valid types: ${T.join(", ")}.\n`);let q=m;if(!S.includes(q))throw new Error(`Error: output file type ${q} is not supported. Valid types: ${S.join(", ")}.\n`);let H,U="";if(M)if(d){const t=e.basename(d),r=e.dirname(d),n=t.split("."),i=n.length;if(i<=1)U=e.resolve(r,`${t}.${q}`);else{const s=n[i-1];S.includes(s)?(q=s,U=e.resolve(d)):(b&&process.stderr.write(`Warning: output file type must be one of 'jpeg', 'png' or 'webp'. Use '${q}' type.\n`),U=e.resolve(r,`${t}.${q}`))}}else U=e.resolve("mdimg_output",function(e){const t=new Date;return`mdimg_${t.getFullYear()}_${t.getMonth()+1}_${t.getDate()}_${t.getHours()}_${t.getMinutes()}_${t.getSeconds()}_${t.getMilliseconds()}.${e}`}(q));"png"!==q&&(H=u>0&&u<=100?u:100);const L=(({inputHtml:r,htmlText:n,cssText:s,htmlTemplate:a,cssTemplate:o,theme:l,log:c})=>{let d=n,m=s;if(!d){let r=e.resolve(__dirname,"../template/html",`${a}.html`);try{t.accessSync(r,t.constants.R_OK)}catch(t){c&&process.stderr.write(`Warning: HTML template ${r} is not found or unreadable. Use default HTML template.\n${t}\n`),r=e.resolve(__dirname,"../template/html/default.html")}d=t.readFileSync(r).toString()}if(!m){let r=e.resolve(__dirname,"../template/css",`${o}.css`);try{t.accessSync(r,t.constants.R_OK)}catch(t){c&&process.stderr.write(`Warning: CSS template ${r} is not found or unreadable. Use default CSS template.\n${t}\n`),r=e.resolve(__dirname,"../template/css/default.css")}m=t.readFileSync(r).toString()}const p=i.load(d);return p("head").append(`<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>mdimg rendering preview</title>\n<style>${m}</style>\n\n\x3c!-- highlight.js --\x3e\n<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/atom-one-${l}.min.css">\n<script defer="defer" src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js" onload="hljs.highlightAll();"><\/script>\n\n\x3c!-- MathJax --\x3e\n<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>\n\n\x3c!-- Mermaid --\x3e\n<script defer="defer" type="module">\n  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';\n  mermaid.initialize({ startOnLoad: true, theme: ${"dark"===l?"dark":void 0} });\n<\/script>`),p(".markdown-body").html(r),p.html()})({inputHtml:await s(j),htmlText:w,cssText:f,htmlTemplate:o(y),cssTemplate:o($),theme:v,log:b});_.html=L;const I=await r.launch({defaultViewport:{width:p,height:h},args:[`--window-size=${p},${h}`],...x}),W=E?e.dirname(e.resolve(E)):process.cwd(),A=e.resolve(W,`.mdimg_temp_${(new Date).getTime()}.html`);try{t.writeFileSync(A,L)}catch(e){process.stderr.write(`Warning: write temporary local HTML file failed, local files may not display correctly. ${e}\n`)}const C=t.existsSync(A);try{const r=await I.newPage();C?await r.goto(`file://${A}`,{waitUntil:"networkidle0"}):await r.setContent(L,{waitUntil:"networkidle0"});const n=await r.$("#mdimg-body");if(!n)throw new Error(`Error: missing HTML element with id: mdimg-body.\nHTML template ${y} is not valid.\n`);if("binary"===k||"blob"===k){M&&function(r){const n=e.dirname(r);try{t.mkdirSync(n,{recursive:!0}),t.writeFileSync(r,"")}catch(e){throw new Error(`Error: create new file ${r} failed.\n${String(e)}\n`)}}(U);const r=await n.screenshot({path:M?U:void 0,type:q,quality:H,encoding:"binary"});b&&process.stderr.write(`Info: convert to image${M?` and saved as ${U}`:""} successfully!\n`),_.data=r,_.path=M?U:void 0}else if("base64"===k){const e=await n.screenshot({type:q,quality:H,encoding:"base64"});b&&process.stderr.write("Info: convert to BASE64 encoded string successfully!\n"),_.data=e}}catch(e){throw new Error(String(e))}finally{await(async()=>{C&&t.rmSync(A),await I.close()})()}return _};function o(e){return e.split(".")[0]}exports.convert2img=a,exports.mdimg=a;
